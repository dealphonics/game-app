<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Subway Surfers 2.5D - Demo</title>
<style>
  body, html {
    margin: 0; padding: 0; overflow: hidden; background: linear-gradient(135deg, #1a1a2e, #0f0f23);
    font-family: Arial, sans-serif; color: white; user-select: none;
  }
  #gameCanvas {
    display: block;
    margin: 0 auto;
    background: #111;
    border: 2px solid #4ecdc4;
    border-radius: 12px;
    touch-action: none;
  }
  #scoreBoard {
    position: fixed;
    top: 10px; left: 50%; transform: translateX(-50%);
    font-size: 24px; font-weight: bold;
    color: #4ecdc4;
    text-shadow: 0 0 10px #4ecdc4;
    user-select: none;
  }
  #instructions {
    position: fixed;
    bottom: 10px; left: 50%; transform: translateX(-50%);
    font-size: 14px;
    color: #888;
    user-select: none;
  }
</style>
</head>
<body>

<div id="scoreBoard">Очки: 0</div>
<canvas id="gameCanvas" width="480" height="640"></canvas>
<div id="instructions">← → — смена дорожки, ↑ — прыжок, ↓ — скольжение</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;

  // Игрок
  const player = {
    lane: 1, // 0 - левый, 1 - средний, 2 - правый
    x: 0,
    y: 0,
    width: 40,
    height: 60,
    state: 'running', // running, jumping, sliding, dead
    jumpProgress: 0,
    slideProgress: 0,
    speedY: 0,
    baseY: 0,
    invulnerable: false,
  };

  // Дорожки (x координаты)
  const lanesX = [width/4 - 50, width/2 - 20, 3*width/4 + 10];

  // Игровые объекты
  let obstacles = [];
  let coins = [];

  // Скорость игры
  let speed = 6;
  let score = 0;
  let gameOver = false;

  // Управление
  let keys = {};
  let touchStartX = null;
  let touchStartY = null;

  // Звуки (простейший beep)
  function beep() {
    try {
      const ctxAudio = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = ctxAudio.createOscillator();
      oscillator.type = 'square';
      oscillator.frequency.setValueAtTime(440, ctxAudio.currentTime);
      oscillator.connect(ctxAudio.destination);
      oscillator.start();
      oscillator.stop(ctxAudio.currentTime + 0.1);
    } catch (e) {
      // no sound
    }
  }

  // Инициализация
  function init() {
    player.lane = 1;
    player.x = lanesX[player.lane];
    player.y = height - 100;
    player.baseY = player.y;
    player.state = 'running';
    player.jumpProgress = 0;
    player.slideProgress = 0;
    player.speedY = 0;
    player.invulnerable = false;

    obstacles = [];
    coins = [];
    score = 0;
    speed = 6;
    gameOver = false;
    document.getElementById('scoreBoard').textContent = 'Очки: 0';
  }

  // Создание препятствий и монет
  function spawnObjects() {
    if (Math.random() < 0.03) {
      // Препятствие
      const lane = Math.floor(Math.random() * 3);
      obstacles.push({
        lane,
        x: lanesX[lane],
        y: -60,
        width: 40,
        height: 60,
        type: 'obstacle',
      });
    }
    if (Math.random() < 0.05) {
      // Монета
      const lane = Math.floor(Math.random() * 3);
      coins.push({
        lane,
        x: lanesX[lane] + 10,
        y: -40,
        radius: 10,
        type: 'coin',
      });
    }
  }

  // Обновление состояния игрока
  function updatePlayer() {
    // Горизонтальное движение
    const targetX = lanesX[player.lane];
    player.x += (targetX - player.x) * 0.3;

    // Вертикальное движение
    if (player.state === 'jumping') {
      player.jumpProgress += 0.1;
      player.y = player.baseY - 150 * Math.sin(Math.PI * player.jumpProgress);
      if (player.jumpProgress >= 1) {
        player.state = 'running';
        player.y = player.baseY;
        player.jumpProgress = 0;
      }
    } else if (player.state === 'sliding') {
      player.slideProgress += 0.1;
      if (player.slideProgress >= 1) {
        player.state = 'running';
        player.slideProgress = 0;
        player.height = 60;
      }
    }
  }

  // Обновление объектов
  function updateObjects() {
    obstacles.forEach(o => {
      o.y += speed;
    });
    obstacles = obstacles.filter(o => o.y < height + 100);

    coins.forEach(c => {
      c.y += speed;
    });
    coins = coins.filter(c => c.y < height + 50);
  }

  // Проверка столкновений
  function checkCollisions() {
    if (player.invulnerable) return;

    // Препятствия
    for (const o of obstacles) {
      if (o.lane === player.lane) {
        if (player.y + player.height > o.y && player.y < o.y + o.height) {
          gameOver = true;
          return;
        }
      }
    }

    // Монеты
    for (let i = coins.length - 1; i >= 0; i--) {
      const c = coins[i];
      if (c.lane === player.lane) {
        const distY = Math.abs((player.y + player.height / 2) - c.y);
        if (distY < 30) {
          coins.splice(i, 1);
          score += 10;
          document.getElementById('scoreBoard').textContent = 'Очки: ' + score;
          beep();
        }
      }
    }
  }

  // Рисуем игрока
  function drawPlayer() {
    ctx.save();
    ctx.translate(player.x, player.y);

    // Тело
    ctx.fillStyle = '#4ecdc4';
    ctx.beginPath();
    ctx.ellipse(0, 0, 15, 25, 0, 0, Math.PI * 2);
    ctx.fill();

    // Голова
    ctx.fillStyle = '#2c3e50';
    ctx.beginPath();
    ctx.ellipse(0, -20, 12, 15, 0, 0, Math.PI * 2);
    ctx.fill();

    // Визор
    ctx.fillStyle = '#a0d8ef';
    ctx.beginPath();
    ctx.ellipse(0, -20, 8, 8, 0, 0, Math.PI * 2);
    ctx.fill();

    // Джетпак (если активен)
    if (player.jetpack > 0) {
      ctx.fillStyle = 'orange';
      ctx.beginPath();
      ctx.moveTo(-10, 10);
      ctx.lineTo(-20, 30);
      ctx.lineTo(-5, 30);
      ctx.closePath();
      ctx.fill();
    }

    ctx.restore();
  }

  // Рисуем объекты
  function drawObjects() {
    // Дорожки
    ctx.fillStyle = '#222';
    ctx.fillRect(0, 0, width, height);

    // Линии между дорожками
    ctx.strokeStyle = '#444';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(width / 3, 0);
    ctx.lineTo(width / 3, height);
    ctx.moveTo(2 * width / 3, 0);
    ctx.lineTo(2 * width / 3, height);
    ctx.stroke();

    // Препятствия
    obstacles.forEach(o => {
      ctx.fillStyle = '#e74c3c';
      ctx.fillRect(o.x - 15, o.y, o.width, o.height);
    });

    // Монеты
    coins.forEach(c => {
      ctx.fillStyle = 'gold';
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  // Основной цикл
  function loop() {
    if (gameOver) {
      drawObjects();
      drawPlayer();
      drawGameOver();
      return;
    }
    updatePlayer();
    updateObjects();
    checkCollisions();
    drawObjects();
    drawPlayer();
    requestAnimationFrame(loop);
  }

  // Отрисовка оверлея “Игра окончена”
  function drawGameOver() {
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = 'white';
    ctx.font = 'bold 36px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Игра окончена', width / 2, height / 2 - 40);

    ctx.font = '24px Arial';
    ctx.fillText('Ваш счёт: ' + score, width / 2, height / 2);

    ctx.font = '18px Arial';
    ctx.fillText('Нажмите пробел или тап, чтобы начать заново', width / 2, height / 2 + 40);
  }

  // Управление
  function onKeyDown(e) {
    if (gameOver && (e.code === 'Space' || e.code === 'Enter')) {
      restart();
    }
    if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
      player.lane = Math.max(0, player.lane - 1);
    }
    if (e.code === 'ArrowRight' || e.code === 'KeyD') {
      player.lane = Math.min(2, player.lane + 1);
    }
    if (e.code === 'ArrowUp' || e.code === 'KeyW') {
      if (player.state !== 'jumping') {
        player.state = 'jumping';
        player.jumpProgress = 0;
      }
    }
    if (e.code === 'ArrowDown' || e.code === 'KeyS') {
      if (player.state !== 'sliding') {
        player.state = 'sliding';
        player.slideProgress = 0;
      }
    }
  }

  // Перезапуск игры
  function restart() {
    gameOver = false;
    score = 0;
    player.lane = 1;
    player.x = lanesX[player.lane];
    player.y = height - 100;
    player.state = 'running';
    player.jumpProgress = 0;
    player.slideProgress = 0;
    player.speedY = 0;
    baseY = player.y;
    minY = player.y;
    obstacles = [];
    coins = [];
    requestAnimationFrame(loop);
  }

  // Инициализация
  function startGame() {
    gameOver = false;
    score = 0;
    player.lane = 1;
    player.x = lanesX[player.lane];
    player.y = height - 100;
    player.state = 'running';
    player.jumpProgress = 0;
    player.slideProgress = 0;
    player.speedY = 0;
    baseY = player.y;
    minY = player.y;
    obstacles = [];
    coins = [];
    enableTilt();
    requestAnimationFrame(loop);
  }

  // Слушатели
  window.addEventListener('keydown', onKeyDown);
  canvas.addEventListener('touchstart', e => {
    if (gameOver) {
      restart();
    } else {
      shoot();
    }
  });

  // Экспорт функций
  window.startGame = startGame;
  window.restart = restart;

  // Начинаем игру при загрузке
  startGame();

  // --- Вспомогательные функции и переменные ---
  const lanesX = [width / 4 - 50, width / 2 - 20, 3 * width / 4 + 10];

  // ... (остальной код из начала скрипта) ...

})();
</script>
